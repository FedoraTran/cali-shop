<main class="detail-wrapper" aria-live="polite">
  @if (product(); as p) {
    <div class="product-detail">
      <div class="detail-layout">
        <div class="gallery">
          @if (activeImage(); as mainImg) {
            <div class="main-img">
              <img [ngSrc]="mainImg" [alt]="p.name" width="500" height="500" priority>
            </div>
          }
          @if (p.images && p.images.length > 0) {
            <div class="thumbs" role="group" aria-label="Ảnh sản phẩm">
              @for (img of p.images; track img; let i = $index) {
                <button
                  class="thumb"
                  [class.active]="img === activeImage()"
                  (click)="setActiveImage(img)"
                  [attr.aria-label]="'Ảnh ' + (i + 1)">
                  <img [ngSrc]="img" [alt]="p.name + ' hình ' + (i + 1)" width="80" height="80">
                </button>
              }
            </div>
          }
        </div>
        <div class="info-panel">
          <div class="badges">
            <span class="badge" [class]="p.category">{{ labelCategory(p.category) }}</span>
          </div>
          <h2 class="detail-title">{{ p.name }}</h2>
          @if(p.desc) {
            <p class="detail-desc">{{ p.desc }}</p>
          }
          <div class="price-block">
            <span class="price">{{ formatPrice(p.price) }}</span>
            @if (p.oldPrice) {
              <span class="old-price">{{ formatPrice(p.oldPrice) }}</span>
            }
            @if (discountPercent() > 0) {
              <span class="discount-badge">-{{ discountPercent() }}%</span>
            }
          </div>
          @if(p.specs) {
            <div class="detail-specs">
              @for (spec of p.specs; track spec) {
                <span class="badge">{{ spec }}</span>
              }
            </div>
          }
          <div class="actions-row">
            <button class="buy-btn">MUA NGAY</button>
            <a routerLink="/" class="back-btn">Quay lại</a>
          </div>
        </div>
      </div>
      @if (hasTechSpecs() && showTechSpecs()) {
        <section class="tech-specs" aria-labelledby="specs-heading">
          <h3 id="specs-heading">Thông số kỹ thuật</h3>
          @for (cat of p.techSpecs; track cat.name; let i = $index) {
            <details class="spec-cat" [attr.open]="i === 0 ? '' : null">
              <summary>{{ cat.name }}</summary>
              <dl class="spec-list">
                @for (item of cat.items; track item.label) {
                  <div class="spec-row">
                    <dt>{{ item.label }}:</dt>
                    <dd>{{ item.value }}</dd>
                  </div>
                }
              </dl>
            </details>
          }
        </section>
      }
    </div>
  } @else {
    <div class="not-found">
      Không tìm thấy sản phẩm. <br/>
      <a routerLink="/" class="back-btn">Quay về danh sách</a>
    </div>
  }
</main>

@if (displayedRelatedProducts().length > 0) {
  <aside class="related-products" aria-labelledby="related-heading">
    <h3 id="related-heading">Sản phẩm tương tự</h3>
    <div class="product-grid">
      @for (item of displayedRelatedProducts(); track item.id) {
        <a [routerLink]="['/product', item.id]" class="product-card">
          <img [ngSrc]="item.image" [alt]="item.name" width="200" height="200" class="product-img">
          <div class="product-info">
            <h4 class="product-name">{{ item.name }}</h4>
            <p class="product-price">{{ formatPrice(item.price) }}</p>
          </div>
        </a>
      }
    </div>
  </aside>
}
